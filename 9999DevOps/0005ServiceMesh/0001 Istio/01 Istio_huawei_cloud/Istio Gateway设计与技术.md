

# Istio Gatewayè®¾è®¡ä¸æŠ€æœ¯

[TOC]

## Gatewayç®€ä»‹

è¿™é‡Œåªæ˜¯ä¸»è¦è®²è§£Istio-Gatewayã€‚

åœ¨Istioä¸­ï¼ŒGatewayæ§åˆ¶ç€ç½‘æ ¼è¾¹ç¼˜çš„æœåŠ¡æš´éœ²ã€‚

**ä¸¤ä¸ªæ–¹å‘**

+ ç½‘æ ¼å¤–çš„æœåŠ¡è®¿é—®k8sç½‘æ ¼å†…éƒ¨çš„æœåŠ¡ï¼Œéœ€è¦Istioçš„Gatewayã€‚
+ Istioçš„ç½‘æ ¼ä¸­é»˜è®¤ä¸èƒ½è®¿é—®å¤–éƒ¨æœåŠ¡çš„ï¼Œå¦‚æœè¦è®¿é—®å¿…é¡»åˆ›å»ºç›¸åº”çš„è§„åˆ™ï¼Œæ¯”å¦‚ServiceEntryæ¥è®¿é—®å¤–éƒ¨æœåŠ¡ã€‚ä½†æ˜¯è®¿é—®å¤–éƒ¨æœåŠ¡ä¸åº”è¦ç”¨Gatewayï¼Œç”¨Gatewayåªæ˜¯ä¸ºäº†æœåŠ¡æ²»ç†ã€‚

![image-20200215131220304](./images/image-20200215131220304.png)

 Gateway ä¹Ÿæ˜¯å¯ä»¥çœ‹åšç½‘æ ¼çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

1ã€L4-L6çš„è´Ÿè½½å‡è¡¡

2ã€å¯¹å¤–çš„mTLS	 

IstioæœåŠ¡ç½‘æ ¼ä¸­ï¼ŒGatewayå¯ä»¥éƒ¨ç½²ä»»æ„å¤šä¸ªï¼Œä¹Ÿæ˜¯å¯ä»¥å…±ç”¨ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æ¯ä¸ªç§Ÿæˆ·ã€namespaceså•ç‹¬éš”ç¦»ã€‚

>Gatewayå¯ä»¥ç”¨å…±ç”¨ï¼Œä¹Ÿå¯ä»¥æ¯ä¸ªæœåŠ¡éƒ¨ç½²ä¸€ä¸ªï¼Œä½†æ˜¯ä¸ºäº†éš”ç¦»æ€§æ›´å¥½  ã€‚

### Gatewayé…ç½®è§„åˆ™

Istio æœ‰ä¸ªcrdå¯¹è±¡ï¼Œå«Gatewayï¼Œé€šè¿‡è¿™ä¸ªcrdåˆ›å»ºè‡ªå·±çš„Gatewayã€‚

é…ç½®ä»‹ç»ï¼š

+ Servers

  Port é…ç½®å¯¹åº”çš„ç«¯å£åè®®

  Hosts é…ç½®==å¤–éƒ¨è®¿é—®==çš„åŸŸåæ¯”å¦‚ï¼šbookinfo.comï¼Œä¹Ÿæ˜¯å¯ä»¥é…ç½®é€šé…ç¬¦`*`ï¼Œä»»ä½•åŸŸåè®¿é—®ã€‚

  TLS å½“å‰æš´éœ²çš„æœåŠ¡çš„TLSè®¾ç½®ï¼Œå›¾ä¸­æ˜¯HTTPSæ‰€ä»¥è¦è®¾ç½®ï¼Œå¦‚æœæ˜¯åè®®æ˜¯HTTPåˆ™è®¾ç½®ä¸ºç©ºæˆ–è€…ä¸è®¾ç½®ã€‚

  ![image-20200215133552851](./images/image-20200215133552851.png)

Gatewayåªæ˜¯å®šä¹‰è™šæ‹Ÿçš„serverï¼Œserver çš„è·¯ç”±éœ€è¦é€šè¿‡VirtualServiceï¼ŒVirtualServiceå’ŒGatewayç»‘å®šæ‰èƒ½è®©æ•´ä¸ªæœåŠ¡ç”Ÿæ•ˆã€‚

+ Hosts å¯¹åº”ä¸Šé¢Gatewayé…ç½®çš„åŸŸå
+ gateways é…ç½®çš„ä¸Šé¢å¯¹åº”Gatewayåå­—
+ http è·¯ç”±è§„åˆ™ï¼Œé€šè¿‡matchåŒ¹é…å¯¹åº”URLåœ¨é€šè¿‡routeè·¯ç”±åˆ°å¯¹åº”æœåŠ¡

![image-20200215133913705](./images/image-20200215133913705.png)

### Gatewayçš„æµå…¥æµå‡º

Gatewayæ ¹æ®æµå…¥æµå‡ºæ–¹å‘åˆ†ä¸ºingress gatewayå’Œengress gateway

![image-20200215134410114](./images/image-20200215134410114.png)

+ ingress gateway

  æ§åˆ¶å¤–éƒ¨æœåŠ¡è®¿é—®ç½‘æ ¼å†…æœåŠ¡ï¼Œè¦é…åˆVirtualService

+ engress gateway

  æ§åˆ¶ç½‘æ ¼å†…æœåŠ¡è®¿é—®å¤–éƒ¨æœåŠ¡ï¼Œé…åˆDestinationRule ServiceEntryä½¿ç”¨

  > å…¶å®æˆ‘ä»¬è®¿é—®å¤–éƒ¨æœåŠ¡ä¹Ÿå¯ä»¥ä¸ç”¨engress gatewayï¼Œå¯ä»¥ç›´æ¥å†™åœ°å€è®¿é—®ï¼Œè¿™é‡Œè¯´ä¸ºä»€ä¹ˆè¦ç”¨æ˜¯å› ä¸ºæœ¬èº«æœåŠ¡æ‰€åœ¨çš„èŠ‚ç‚¹å¯èƒ½æ²¡æœ‰ç›´æ¥è®¿é—®å¤–ç½‘çš„æƒé™	 è¿™ç§æƒ…å†µéœ€è¦engress gatewayã€‚æˆ–è€…éœ€è¦æ›´å¼ºå¤§çš„æœåŠ¡æ²»ç†åŠŸèƒ½ã€‚	 

## Gateway vs Kubernetes Ingress

Kubernetes Ingressæ˜¯é›†ç¾¤å†…çš„ä¸€ç§æœåŠ¡æš´éœ²æ–¹å¼ï¼Œæä¾›é›†ç¾¤å†…è®¿é—®å…¥å£ï¼Œä»…æ”¯æŒL7(http,https)è´Ÿè½½å‡è¡¡ï¼ŒåŠŸèƒ½å•ä¸€ï¼Œredis mongoéƒ½ä¸æ”¯æŒ

Istio1.0ä»¥å‰ï¼Œåˆ©ç”¨Kubernetes Ingresså®ç°ç½‘æ ¼å†…éƒ¨æœåŠ¡æš´éœ²ã€‚

ä½†æ˜¯Ingress æ— æ³•å®ç°å¾ˆå¤šåŠŸèƒ½ï¼š

1. L4-L6 tcp redis mongo è´Ÿè½½å‡è¡¡

2. å¯¹å¤–mTLS åŒå‘è®¤è¯

3. SNI çš„æ”¯æŒ

4. å…¶ä»–istioä¸­å·²ç»å®ç°çš„å†…éƒ¨ç½‘ç»œåŠŸèƒ½ï¼šFault Injectionï¼ŒTraffic Shiftingï¼ŒCircuit Brreakingï¼ŒMirroring

   

**ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼ŒIstioåœ¨1.0ç‰ˆæœ¬è®¾è®¡äº†æ–°v1apha3APIã€‚**

å‡ºç°è‡ªå·±çš„Gatewayï¼Œç›¸å¯¹Kubernetes Ingresså‘¢å‡ºç°å¦‚ä¸‹å¥½å¤„ï¼š

+ Gatewayå…è®¸ç®¡ç†å‘˜æŒ‡å®šL4-L6çš„è®¾ç½®ï¼šç«¯å£åŠTLSè®¾ç½®ã€‚
+ å¯¹äºIngressçš„L7è®¾ç½®ï¼ŒIstioå…è®¸VirtualServiceä¸Gatewayç»‘å®šèµ·æ¥ã€‚
+ ä¸ºä»€ä¹ˆä¸æŠŠVirtualServiceä¸Gatewayæ”¾åœ¨ä¸€èµ·ï¼Œåˆ†ç¦»çš„å¥½å¤„ï¼šç”¨æˆ·å¯ä»¥åƒä½¿ç”¨ä¼ ç»Ÿçš„è´Ÿè½½å‡è¡¡è®¾å¤‡ä¸€æ ·ç®¡ç†è¿›å…¥ç½‘æ ¼å†…éƒ¨çš„æµé‡ï¼Œç»‘å®šè™šæ‹ŸIPåˆ°è™šæ‹ŸæœåŠ¡å™¨ä¸Šã€‚ä¾¿äºä¼ ç»ŸæŠ€æœ¯ç”¨æˆ·æ— ç¼è¿ç§»åˆ°å¾®æœåŠ¡ã€‚

## Gateway åŸç†åŠå®ç°

Gatewayä¹Ÿæ˜¯é€šè¿‡æœåŠ¡å‘ç°çš„æ–¹å¼å‘ç°ç”Ÿæˆç›¸åº”çš„è§„åˆ™ï¼Œç„¶åæŠŠç›¸åº”çš„è§„åˆ™é…ç½®åˆ°Gatewayä¸Šçš„ã€‚

**åœ¨Istioæµç¨‹ï¼š**

â€‹			Piloté€šè¿‡Platform Adapter é€‚é…å™¨æ¥ç®¡åˆ°Kubernetesæˆ–è€…Consulæˆ–è€…MCPè¿™æ ·å¹³å°çš„ç›¸åº”çš„Ruleè§„åˆ™çš„å¢åˆ æ”¹æŸ¥ï¼Œé€‚é…å±‚å¯¹æ³¨å†Œä¸­å¿ƒæ— æ„ŸçŸ¥ã€‚ç„¶åé€šè¿‡Aggergator Registryèšåˆå±‚ç”Ÿæˆç»Ÿä¸€çš„æ¥å£è°ƒç”¨ï¼Œæä¾›æ¨é€ç»™ADSåœ¨IStioå°±æ˜¯listener,routeï¼Œclasst endpoint,è¿™é‡Œå°±æ˜¯æ¨é€ç»™çš„æ˜¯Gatewayã€‚

![image-20200215140851392](./images/image-20200215140851392.png)



**åœ¨k8sçš„æµç¨‹ï¼š**

â€‹		ç”¨æˆ·é€šè¿‡kubectl è°ƒç”¨ApiServer åˆ›å»ºService Podï¼Œç„¶åå­˜å‚¨åˆ°etcd,ç„¶åPiloté€šè¿‡Lsit/Watch æ‹¿å»åˆ°èµ„æºå¯¹è±¡Service ,Endpoints,Pod CRDsè½¬å‡ºç›¸åº”çš„è§„åˆ™ä¸‹å‘åˆ°Envoyã€‚

![image-20200215142105768](./images/image-20200215142105768.png)

Gateway ä¸æ™®é€šçš„sidecar å‡æ˜¯ä½¿ç”¨Envoyä½œä¸ºProxyå®ç°æµé‡æ§åˆ¶ã€‚Pilotä¸ºä¸åŒç±»å‹çš„Proxyç”Ÿæˆç›¸åº”çš„é…ç½®ï¼ŒGatewayçš„ç±»å‹ä¸ºrouterï¼Œsidecarçš„ç±»å‹ä¸ºsidecarã€‚

Ingress Gateway å¯åŠ¨å‚æ•°ï¼š

![image-20200215143225492](./images/image-20200215143225492.png)

Sidecar å¯åŠ¨å‚æ•°ï¼š

![image-20200215143339096](./images/image-20200215143339096.png)



**Pilot å¦‚ä½•å¾—çŸ¥proxyç±»å‹ï¼Ÿ**

Envoy å‘ç°æœåŠ¡ä½¿ç”¨çš„xDSåè®®ï¼ŒEnvoyå‘serverç«¯pilotå‘èµ·è¯·æ±‚DiscoveryRequestæ—¶ä¼šæºå¸¦è‡ªèº«ä¿¡æ¯nodeï¼Œnodeyæœ‰ä¸€ä¸ªIDæ ‡è¯†ï¼Œpilotä¼šè§£ænodeæ ‡è¯†è·å–proxyç±»å‹ã€‚

>åœ¨Istioä¸­ä¸€å…±æœ‰ä¸‰ç§ç±»å‹ï¼šrouteï¼Œsidecarï¼Œingress ï¼Œingresså’Œrouteæ˜¯ä¸€ç§ç±»å‹ï¼Œingressæ˜¯å†å²é—ç•™çš„ç±»å‹ã€‚

![image-20200215144150212](./images/image-20200215144150212.png)

Envoyçš„èŠ‚ç‚¹æ ‡è¯†å¯ä»¥é€šè¿‡é™æ€é…ç½®æ–‡ä»¶åˆ¶å®šï¼Œä¹Ÿå¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•° `--service-node`æŒ‡å®šã€‚

Gatewayå¯¹è±¡åœ¨Istioä¸­æ˜¯ç”¨CRDå£°æ˜çš„ï¼Œå¯ä»¥é€šè¿‡`$kubectl get crd gateways.networking,istio,io`éªŒè¯ã€‚

![image-20200215144550231](./images/image-20200215144550231.png)

IStio networkingæ‰€æœ‰é…ç½®APIå®šä¹‰ï¼š

> æˆ‘è¡¨ç¤ºè¿™é‡Œå¹¶æ²¡æœ‰å¬å¤ªæ‡‚ï¼Œæ‰€æ²¡æœ‰å†™ğŸ¤”

![image-20200215145003605](./images/image-20200215145003605.png)

![image-20200215145036944](./images/image-20200215145036944.png)



![image-20200215145054200](./images/image-20200215145054200.png)

![image-20200215171925269](./images/image-20200215171925269.png)



Gatewayé…ç½®ä¸‹å‘ï¼š

éµå¾ªmake-before-breakåŸåˆ™ï¼Œç”µè·¯çš„æ–¹å¼ï¼Œé…ç½®ä¸‹å‘å…ˆåˆå¹¶ï¼Œæœç»è§„åˆ™æ›´æ–°è¿‡ç¨‹å‡ºç°503.

æ¯”å¦‚æ›´æ–°ä¸€ä¸ªendpoint ,å…ˆæŠŠåŸå…ˆçš„endpointä¿ç•™ï¼Œæ–°endpointæ¨é€åˆ°proxyä¹‹åæ‰ä¼šå¹²æ‰è€çš„endpointã€‚

![image-20200215172353776](./images/image-20200215172353776.png)

routerç±»å‹ä¸sidecarç±»å‹çš„proxy æœ€æœ¬è´¨çš„åŒºåˆ«æ˜¯æ²¡æœ‰inbound clusterï¼Œendpointï¼Œlistener

è¿™ä¹Ÿä»ä¾§é¢è¯æ˜Gatewayä¸æ˜¯æµæµªçš„ç»ˆç‚¹åªæ˜¯å……å½“ä¸€ä¸ªä»£ç†è½¬å‘ã€‚

## Gateway demo æ¼”ç¤º

### æ§åˆ¶Ingress HTTPæµé‡





![image-20200215172841136](./images/image-20200215172841136.png)

æœ‰ä¸€ä¸ªhttpbinæœåŠ¡å¤–ç½‘è®¿é—®ä¸é€šï¼Œè¿™æ˜¯httpbinæœåŠ¡çš„service,å› ä¸ºåœ¨ç½‘æ ¼ä¸­ç›´æ¥è®¿é—®

![image-20200215173335322](./images/image-20200215173335322.png)

ç„¶åæœ‰ä¸€ä¸ªgateway é…ç½®å¦‚ä¸‹ï¼š

![image-20200215173246368](./images/image-20200215173246368.png)

![image-20200215173620902](./images/image-20200215173620902.png)





### åˆ©ç”¨HTTPSä¿æŠ¤åç«¯æœåŠ¡

![image-20200215173754666](./images/image-20200215173754666.png)

mode: SIMLE æ˜¯å¯¹å®¢æˆ·ç«¯ä¸éªŒè¯

![image-20200215174026805](./images/image-20200215174026805.png)

![image-20200215174739747](./images/image-20200215174739747.png)

![image-20200215174803502](./images/image-20200215174803502.png)

è®¿é—®æµå‘ï¼šå®¢æˆ·ç«¯é€šè¿‡httpsè¯·æ±‚åˆ°ingress çš„NodePortï¼ŒNodePorté€šè¿‡iptablesè§„åˆ™è½¬å‘åˆ°gatewayçš„podï¼Œgatewayå…¶å®å¼€å¯httpsçš„serverï¼ŒhttpsServerç›‘å¬è¯·æ±‚ï¼Œé€šè¿‡HTTPåè®®è½¬å‘åˆ°httpbinçš„æœåŠ¡ï¼Œå¤„ç†å®Œæˆhttpbinè¿”å›åˆ°ingressï¼Œingresså†ç»™å®¢æˆ·ç«¯ã€‚

### mTLS åŒå‘è®¤è¯

éªŒè¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¯ä¹¦è®¤è¯ã€‚

![image-20200215175047758](./images/image-20200215175047758.png)

åˆ›å»ºä¸€ä¸ªå¸¦åŒä¼‘è®¤è¯çš„gateway

![image-20200215175137147](./images/image-20200215175137147.png)

mtls.yaml

![image-20200215175237646](./images/image-20200215175237646.png)

mode: MUTUAL åŒå‘è®¤è¯

é€š cert.pem è®¤è¯å®¢æˆ·ç«¯çš„è¯ä¹¦

æºå¸¦è¯ä¹¦è®¿é—®httpbinæœåŠ¡

![image-20200215175530745](./images/image-20200215175530745.png)

![image-20200215175548265](./images/image-20200215175548265.png)

è®¿é—®æµå‘ï¼š å®¢æˆ·ç«¯æºå¸¦keyå’Œca,é€šè¿‡httpså‘é€è¯·æ±‚åˆ°åç«¯æœåŠ¡ï¼Œåç«¯æœåŠ¡å®é™…è¢«	ingress gatewayåšäº†è½¬å‘ï¼Œingress gatewayåšä¸ªhttpsåŒå‘è®¤è¯ï¼Œè®¤è¯æˆ‘ä»¬å®¢æˆ·ç«¯çš„è¯ä¹¦ï¼Œè®¤è¯æˆåŠŸå»ºç«‹httpsè¿æ¥ï¼Œå®é™…ingress gatewayå’ŒhttpbinæœåŠ¡è¿˜æ˜¯é€šè¿‡httpçš„åè®®è¿›è¡Œè®¿é—®çš„ã€‚

### æ§åˆ¶egressæµé‡ï¼Œè®¿é—®å¤–éƒ¨æœåŠ¡



![image-20200215181009642](./images/image-20200215181009642.png)

å»ºç«‹ServiceEntry è¿›è¡Œè®¿é—®å¤–éƒ¨æœåŠ¡ï¼ŒæœåŠ¡ç½‘æ ¼ä¸­çš„podå¯èƒ½æ²¡æœ‰ç›´æ¥è®¿é—®å¤–ç½‘çš„æƒé™ï¼Œåªæœ‰ingressGatewayæ‰€åœ¨podæœ‰è¿™ç§æƒé™	ï¼Œé€šè¿‡Gatewayåšä¸€ä¸‹ä»£ç†çš„è½¬å‘

![image-20200215181056327](./images/image-20200215181056327.png)

![image-20200215181205977](./images/image-20200215181205977.png)

åˆ›å»ºä¸€ä¸ªServiceEntry

![image-20200215181237502](./images/image-20200215181237502.png)

![image-20200215181316678](./images/image-20200215181316678.png)

åˆ›å»ºä¸€ä¸ªegress

![image-20200215181532574](./images/image-20200215181532574.png)



è¿›å…¥å®¹å™¨å†…éƒ¨è®¿é—®å¤–éƒ¨æœåŠ¡

![image-20200215181800140](./images/image-20200215181800140.png)

![image-20200215181817599](./images/image-20200215181817599.png)
